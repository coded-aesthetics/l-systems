<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simple Babylon.js L-Systems Test</title>
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family: Arial, sans-serif;
            }
            #canvas {
                width: 800px;
                height: 600px;
                border: 1px solid #ccc;
            }
            .controls {
                margin: 20px 0;
            }
            button {
                padding: 10px 20px;
                margin: 5px;
            }
            #status {
                margin: 10px 0;
                padding: 10px;
                background: #f0f0f0;
            }
        </style>
    </head>
    <body>
        <h1>Simple Babylon.js L-Systems Test</h1>
        <div id="status">Loading...</div>
        <canvas id="canvas"></canvas>
        <div class="controls">
            <button onclick="testBasicTree()">Generate Basic Tree</button>
            <button onclick="testLibraryImport()">Test Library Import</button>
        </div>

        <!-- Babylon.js from CDN -->
        <script src="https://cdn.babylonjs.com/babylon.js"></script>

        <script type="module">
            let engine, scene, camera;
            let status = document.getElementById("status");

            // Test functions
            window.testLibraryImport = async function () {
                status.textContent = "Testing library import...";
                try {
                    const { LSystemsLibrary } = await import(
                        "./dist/lib/LSystemsLibrary.js"
                    );
                    const { BabylonJSAdapter } = await import(
                        "./dist/lib/adapters/BabylonJSAdapter.js"
                    );

                    status.textContent =
                        "Library imports successful! LSystemsLibrary and BabylonJSAdapter loaded.";

                    // Test basic generation
                    const config = {
                        axiom: "F",
                        rules: "F -> F[+F]F[-F]F",
                        iterations: 3,
                        angle: 25,
                    };

                    const geometry = LSystemsLibrary.generateTree(config);
                    status.textContent += ` Generated geometry with ${geometry.statistics.totalVertices} vertices.`;
                } catch (error) {
                    status.textContent = "Error: " + error.message;
                    console.error("Import error:", error);
                }
            };

            window.testBasicTree = async function () {
                status.textContent = "Generating basic tree...";
                try {
                    const { LSystemsLibrary } = await import(
                        "./dist/lib/LSystemsLibrary.js"
                    );
                    const { BabylonJSAdapter } = await import(
                        "./dist/lib/adapters/BabylonJSAdapter.js"
                    );

                    // Clear existing meshes
                    if (scene) {
                        scene.meshes.forEach((mesh) => {
                            if (
                                mesh.name.includes("system") ||
                                mesh.name.includes("branch") ||
                                mesh.name.includes("leaf")
                            ) {
                                mesh.dispose();
                            }
                        });
                    }

                    const config = {
                        axiom: "F",
                        rules: "F -> F[+F]F[-F]F",
                        iterations: 3,
                        angle: 25,
                    };

                    const geometryParams = {
                        length: 1.0,
                        thickness: 0.05,
                        tapering: 0.8,
                    };

                    const options = {
                        materialType: "standard",
                        branchColor: "#8B4513",
                        leafColor: "#228B22",
                    };

                    const meshGroup = BabylonJSAdapter.createMeshFromLSystem(
                        config,
                        geometryParams,
                        options,
                        scene,
                    );

                    // Fit camera to mesh
                    BabylonJSAdapter.fitCameraToMesh(meshGroup, camera);

                    status.textContent = `Tree generated! Vertices: ${meshGroup.stats.totalVertices}, Triangles: ${meshGroup.stats.totalTriangles}`;
                } catch (error) {
                    status.textContent =
                        "Error generating tree: " + error.message;
                    console.error("Generation error:", error);
                }
            };

            // Initialize Babylon.js
            function initBabylon() {
                try {
                    status.textContent = "Initializing Babylon.js...";

                    const canvas = document.getElementById("canvas");
                    engine = new BABYLON.Engine(canvas, true);
                    scene = new BABYLON.Scene(engine);

                    // Set background color
                    scene.clearColor = new BABYLON.Color3(0.2, 0.3, 0.4);

                    // Create camera
                    camera = new BABYLON.ArcRotateCamera(
                        "camera",
                        Math.PI / 4,
                        Math.PI / 3,
                        10,
                        BABYLON.Vector3.Zero(),
                        scene,
                    );
                    camera.attachControl(canvas, true);

                    // Create light
                    const light = new BABYLON.HemisphericLight(
                        "light",
                        new BABYLON.Vector3(0, 1, 0),
                        scene,
                    );
                    light.intensity = 0.8;

                    // Render loop
                    engine.runRenderLoop(() => {
                        scene.render();
                    });

                    // Handle resize
                    window.addEventListener("resize", () => {
                        engine.resize();
                    });

                    status.textContent =
                        "Babylon.js initialized successfully! Click buttons to test.";
                } catch (error) {
                    status.textContent =
                        "Error initializing Babylon.js: " + error.message;
                    console.error("Babylon init error:", error);
                }
            }

            // Start when page loads
            window.addEventListener("DOMContentLoaded", initBabylon);
        </script>
    </body>
</html>
