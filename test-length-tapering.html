<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Length Tapering Parameter Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f0f0f0;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            .controls {
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 5px;
            }
            .control-group {
                margin-bottom: 15px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
            }
            input[type="range"] {
                width: 300px;
                margin-right: 10px;
            }
            .value-display {
                color: #007bff;
                font-weight: normal;
            }
            canvas {
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .test-info {
                background: #e3f2fd;
                padding: 15px;
                border-radius: 5px;
                margin-bottom: 20px;
            }
            .test-examples {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
            .example {
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
                text-align: center;
            }
            .example h3 {
                margin-top: 0;
            }
            button {
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
            }
            button:hover {
                background: #0056b3;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Length Tapering Parameter Test</h1>

            <div class="test-info">
                <h2>What is Length Tapering?</h2>
                <p>
                    The <strong>Length Tapering</strong> parameter controls how
                    much shorter each branch segment becomes as the tree grows.
                    This creates natural-looking trees where branches get
                    progressively shorter towards the tips.
                </p>
                <ul>
                    <li>
                        <strong>100%</strong> - No tapering (all segments same
                        length)
                    </li>
                    <li>
                        <strong>95%</strong> - Default setting (5% reduction per
                        segment)
                    </li>
                    <li>
                        <strong>80%</strong> - Aggressive tapering (20%
                        reduction per segment)
                    </li>
                    <li>
                        <strong>50%</strong> - Extreme tapering (50% reduction
                        per segment)
                    </li>
                </ul>
            </div>

            <div class="controls">
                <h2>Interactive Test</h2>

                <div class="control-group">
                    <label for="lengthTapering">
                        Length Tapering:
                        <span class="value-display" id="lengthTapering-value"
                            >95%</span
                        >
                    </label>
                    <input
                        type="range"
                        id="lengthTapering"
                        min="50"
                        max="100"
                        value="95"
                        step="1"
                    />
                </div>

                <div class="control-group">
                    <label for="iterations">
                        Iterations:
                        <span class="value-display" id="iterations-value"
                            >4</span
                        >
                    </label>
                    <input
                        type="range"
                        id="iterations"
                        min="1"
                        max="6"
                        value="4"
                        step="1"
                    />
                </div>

                <button onclick="generateTree()">Generate Tree</button>
                <button onclick="runTests()">Run All Test Cases</button>
            </div>

            <canvas id="canvas" width="800" height="600"></canvas>

            <div class="test-examples">
                <div class="example">
                    <h3>No Tapering (100%)</h3>
                    <p>Uniform branch lengths</p>
                    <button onclick="testCase(1.0)">Test</button>
                </div>
                <div class="example">
                    <h3>Mild Tapering (95%)</h3>
                    <p>Default natural look</p>
                    <button onclick="testCase(0.95)">Test</button>
                </div>
                <div class="example">
                    <h3>Medium Tapering (85%)</h3>
                    <p>More pronounced tapering</p>
                    <button onclick="testCase(0.85)">Test</button>
                </div>
                <div class="example">
                    <h3>Strong Tapering (70%)</h3>
                    <p>Rapid length reduction</p>
                    <button onclick="testCase(0.70)">Test</button>
                </div>
            </div>
        </div>

        <script type="module">
            import { LSystemsLibrary } from "./dist/lib/LSystemsLibrary.js";

            let library;
            let canvas, ctx;

            // Initialize the test
            document.addEventListener("DOMContentLoaded", async () => {
                canvas = document.getElementById("canvas");
                ctx = canvas.getContext("2d");

                // Initialize the library
                const config = {
                    axiom: "F",
                    rules: "F -> F[+F]F[-F]F",
                    iterations: 4,
                    angle: 25.7,
                    angleVariation: 5,
                    lengthVariation: 10,
                    lengthTapering: 0.95,
                    leafProbability: 0.3,
                    leafGenerationThreshold: 3,
                };

                library = new LSystemsLibrary(config);

                // Setup event listeners
                setupEventListeners();

                // Generate initial tree
                generateTree();
            });

            function setupEventListeners() {
                const lengthTaperingSlider =
                    document.getElementById("lengthTapering");
                const iterationsSlider = document.getElementById("iterations");

                lengthTaperingSlider.addEventListener("input", (e) => {
                    document.getElementById(
                        "lengthTapering-value",
                    ).textContent = e.target.value + "%";
                    generateTree();
                });

                iterationsSlider.addEventListener("input", (e) => {
                    document.getElementById("iterations-value").textContent =
                        e.target.value;
                    generateTree();
                });
            }

            function generateTree() {
                const lengthTapering =
                    parseFloat(
                        document.getElementById("lengthTapering").value,
                    ) / 100;
                const iterations = parseInt(
                    document.getElementById("iterations").value,
                );

                // Update library configuration
                library.updateConfig({
                    lengthTapering: lengthTapering,
                    iterations: iterations,
                });

                // Generate and render
                const geometry = library.generateGeometry(10, 2, 0.8, 8);
                renderGeometry(geometry);
            }

            function testCase(taperingValue) {
                document.getElementById("lengthTapering").value = Math.round(
                    taperingValue * 100,
                );
                document.getElementById("lengthTapering-value").textContent =
                    Math.round(taperingValue * 100) + "%";
                generateTree();
            }

            function runTests() {
                const testCases = [1.0, 0.95, 0.85, 0.7];
                let currentTest = 0;

                function runNextTest() {
                    if (currentTest >= testCases.length) {
                        console.log("All tests completed!");
                        return;
                    }

                    const taperingValue = testCases[currentTest];
                    console.log(
                        `Testing length tapering: ${Math.round(taperingValue * 100)}%`,
                    );

                    testCase(taperingValue);

                    currentTest++;
                    setTimeout(runNextTest, 2000); // Wait 2 seconds between tests
                }

                runNextTest();
            }

            function renderGeometry(geometry) {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Set up 2D rendering context
                ctx.fillStyle = "#8B4513"; // Brown for branches
                ctx.strokeStyle = "#654321";
                ctx.lineWidth = 1;

                // Simple 2D projection of 3D branch data
                const branches = geometry.branches;
                const vertices = branches.vertices;

                // Transform and render vertices as lines
                ctx.beginPath();

                for (let i = 0; i < vertices.length; i += 9) {
                    // Each segment has 3 vertices * 3 coords
                    const x1 = vertices[i] * 100 + canvas.width / 2;
                    const y1 = canvas.height - (vertices[i + 1] * 100 + 100);
                    const x2 = vertices[i + 3] * 100 + canvas.width / 2;
                    const y2 = canvas.height - (vertices[i + 4] * 100 + 100);

                    if (i === 0) {
                        ctx.moveTo(x1, y1);
                    }
                    ctx.lineTo(x2, y2);
                }

                ctx.stroke();

                // Render leaves as green circles
                ctx.fillStyle = "#228B22"; // Green for leaves
                const leaves = geometry.leaves;
                const leafVertices = leaves.vertices;

                for (let i = 0; i < leafVertices.length; i += 3) {
                    const x = leafVertices[i] * 100 + canvas.width / 2;
                    const y = canvas.height - (leafVertices[i + 1] * 100 + 100);

                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // Add debug info
                ctx.fillStyle = "#000";
                ctx.font = "14px Arial";
                const lengthTapering = parseFloat(
                    document.getElementById("lengthTapering").value,
                );
                ctx.fillText(`Length Tapering: ${lengthTapering}%`, 10, 25);
                ctx.fillText(`Branch Vertices: ${vertices.length / 3}`, 10, 45);
                ctx.fillText(
                    `Leaf Vertices: ${leafVertices.length / 3}`,
                    10,
                    65,
                );
            }

            // Make functions globally available
            window.generateTree = generateTree;
            window.testCase = testCase;
            window.runTests = runTests;
        </script>
    </body>
</html>
